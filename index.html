<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Comisiones Comerciales - SERSA SAECA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
            font-family: sans-serif;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #e8eaf0;
            font-size: 12px;
            overflow: hidden;
            height: 100vh;
            color: #212121;
        }

        .container {
            width: 100%;
            padding: 0 10px;
            box-sizing: border-box;
            display: flex;
            height: 100vh;
            gap: 1px;
            background: #ccc;
        }

        /* Panel izquierdo */
        .left-panel {
            width: 320px;
            background: white;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }

        .left-panel.collapsed {
            width: 0;
            padding: 0;
            overflow: hidden;
        }

        .open-sidebar-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            padding: 6px 10px;
            background: #006D77;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #006D77 0%, #83C5BE 100%);
            color: white;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #saveIndicator {
            margin-left: 10px;
            font-size: 11px;
            color: #fff;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #saveIndicator.saving {
            opacity: 1;
        }

        .header h1 {
            font-size: 15px;
            margin: 0;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .input-section {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .input-group label .req {
            color: #e53935;
        }

        .input-field {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #006D77;
            box-shadow: 0 0 0 3px rgba(0,109,119,0.1);
        }

        .input-field.filled {
            border-color: #4CAF50;
        }

        .input-field.empty {
            border-color: #FFA726;
            background: #FFF8E1;
        }

        .input-field.required.empty {
            border-color: #F44336 !important;
            box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.2);
        }

        .help-text {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }

        .status-text {
            font-size: 10px;
            margin-top: 4px;
            display: flex;
            justify-content: space-between;
        }

        .status-text .status {
            color: #4CAF50;
            font-weight: 600;
        }

        .status-text .warning {
            color: #FFA726;
        }

        .status-text .llave {
            color: #666;
        }

        .section-divider {
            font-size: 11px;
            font-weight: 700;
            color: #006D77;
            margin: 15px 0 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Panel derecho */
        .right-panel {
            flex: 1;
            background: #f5f6f8;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-stats {
            background: white;
            padding: 12px 20px;
            display: flex;
            gap: 30px;
            justify-content: space-around;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #006D77;
        }

        .results-container {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Tarjetas */
        .card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        .card-title {
            font-size: 12px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        /* Barras de progreso clickeables */
        .progress-bar-container {
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 48px;
            background: #f0f0f0;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .progress-segments {
            display: flex;
            height: 100%;
        }

        .progress-segment {
            flex: 1;
            border-right: 1px solid #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: #666;
            position: relative;
            transition: all 0.2s;
            cursor: pointer;
        }

        .progress-segment:hover {
            background: rgba(0,109,119,0.1);
            transform: scale(1.02);
        }

        .progress-segment.reached {
            background: #C8E6C9;
            color: #2E7D32;
            font-weight: 600;
        }

        .progress-segment.reached:hover {
            background: #A5D6A7;
        }

        .progress-segment.current {
            background: #006D77;
            color: white;
        }

        .progress-segment .level {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .progress-segment .meta {
            font-size: 9px;
            opacity: 0.8;
        }

        .progress-segment .premio {
            font-size: 10px;
            font-weight: 600;
            margin-top: 2px;
        }

        .progress-info {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
            text-align: center;
        }

        .progress-info strong {
            color: #006D77;
        }

        /* Barra de subtotal */
        .subtotal-bar {
            height: 60px;
            background: #f0f0f0;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .subtotal-fill {
            height: 100%;
            transition: all 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            background: linear-gradient(90deg, #8BC34A 0%, #4CAF50 100%);
        }

        .subtotal-text {
            font-size: 14px;
            text-align: center;
            margin-top: 8px;
            color: #333;
        }

        .subtotal-text strong {
            color: #006D77;
            font-size: 16px;
        }

        /* Llave semanal */
        .llave-info {
            background: #FFF3E0;
            border: 1px solid #FFB74D;
            border-radius: 4px;
            padding: 8px;
            margin-top: 8px;
            font-size: 11px;
        }

        .llave-rules {
            margin-top: 4px;
            color: #E65100;
        }

        .llave-rules div {
            padding: 2px 0;
        }

        /* Cálculo de comisión compacto */
        .commission-calculation {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .calc-section {
            background: linear-gradient(135deg, #006D77 0%, #83C5BE 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
        }

        .calc-row.negative {
            color: #FFCDD2;
        }

        .calc-divider {
            border-top: 1px solid rgba(255,255,255,0.3);
            margin: 6px 0;
        }

        .calc-total {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            margin-top: 8px;
        }

        .calc-total-label {
            font-size: 10px;
            opacity: 0.9;
        }

        .calc-total-value {
            font-size: 20px;
            font-weight: bold;
            margin-top: 4px;
        }

        /* Sugerencias compactas */
        .suggestions-section {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            height: 100%;
            overflow-y: auto;
        }

        .suggestion-category {
            margin-bottom: 10px;
            padding: 6px;
            border-radius: 4px;
            border-left: 3px solid #ddd;
        }

        .suggestion-category.high-priority {
            border-left-color: #F44336;
            background: #FFEBEE;
        }

        .suggestion-category.quick-wins {
            border-left-color: #FFC107;
            background: #FFF8E1;
        }

        .suggestion-category.multipliers {
            border-left-color: #2196F3;
            background: #E3F2FD;
        }

        .suggestion-category.goals {
            border-left-color: #4CAF50;
            background: #E8F5E9;
        }

        .suggestion-category.alerts {
            border-left-color: #FF5722;
            background: #FBE9E7;
        }

        .suggestion-category-title {
            font-size: 10px;
            font-weight: 700;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .suggestion-item {
            font-size: 10px;
            padding: 2px 0;
            line-height: 1.3;
        }

        /* Multiplicadores con tabla completa */
        .multiplier-tables {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
        }

        .multiplier-table {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 4px;
            border: 2px solid transparent;
        }

        .multiplier-table.good {
            border-color: #4CAF50;
            background: #E8F5E9;
        }

        .multiplier-table.warning {
            border-color: #FFA726;
            background: #FFF8E1;
        }

        .multiplier-table.danger {
            border-color: #F44336;
            background: #FFEBEE;
        }

        .multiplier-title {
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 2px;
            color: #333;
        }

        .multiplier-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 5px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
        }

        .multiplier-row:hover {
            background: rgba(0,0,0,0.05);
        }

        .multiplier-row.active {
            background: rgba(0,109,119,0.2);
            font-weight: 600;
        }

        .multiplier-current {
            text-align: center;
            font-size: 13px;
            margin-top: 4px;
            color: #666;
        }

        .multiplier-calc {
            text-align: center;
            font-size: 16px;
            margin-top: 8px;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        /* Información de carrera y guía */
        .info-section {
            background: #F5F5F5;
            border-left: 3px solid #006D77;
            padding: 10px;
            margin-top: 10px;
            font-size: 11px;
            line-height: 1.5;
        }

        .info-section h4 {
            color: #006D77;
            margin-bottom: 6px;
        }

        .quick-guide {
            background: #E8F5E9;
            border-left: 3px solid #4CAF50;
            margin-top: 10px;
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: #006D77;
            font-weight: bold;
        }

        .tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 10;
            font-weight: normal;
        }

        .tooltip:hover::before {
            content: '';
            position: absolute;
            bottom: 14px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0 6px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
            z-index: 11;
        }

        /* Utilidades */
        .text-muted {
            color: #666;
            font-size: 10px;
        }

        .text-success { color: #4CAF50; }
        .text-warning { color: #FFA726; }
        .text-danger { color: #F44336; }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }

            .left-panel {
                width: 100%;
                max-height: 40vh;
            }
            
            .results-container {
                grid-template-columns: 1fr;
            }
            
            .commission-calculation {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 992px) {
            .open-sidebar-btn {
                display: block;
            }
            .container {
                flex-direction: column;
            }
            .left-panel {
                width: 100%;
                max-height: none;
            }
            .commission-calculation {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="header">
                <h1>💰 Sistema de Comisiones Comerciales</h1>
                <span id="saveIndicator"></span>
                <div class="header-buttons">
                    <button id="limpiarBtn" class="header-btn">🗑️ Limpiar</button>
                    <button id="reporteBtn" class="header-btn">📊 Reporte</button>
                    <button id="toggleSidebarBtn" class="header-btn">⬅️ Ocultar</button>
                </div>
            </div>
            
            <div class="input-section">
                <div class="section-divider">═══ HISTORIAL ═══</div>
                
                <div class="input-group">
                    <label>Nivel mes anterior</label>
                    <select class="input-field" id="nivelAnterior">
                        <option value="0">Capilla</option>
                        <option value="1">Junior</option>
                        <option value="2" selected>Senior A</option>
                        <option value="3">Senior B</option>
                        <option value="4">Máster</option>
                        <option value="5">Genio</option>
                    </select>
                    <div class="help-text">Para cálculo de carrera (menor de 2 meses)</div>
                </div>
                
                <div class="section-divider">═══ VOLUMEN ═══</div>
                
                <div class="input-group">
                    <label>Monto Interno <span class="req">*</span></label>
                    <input type="text" class="input-field required" id="montoInterno" placeholder="Ej: 950.000.000">
                    <div class="status-text">
                        <span id="internoStatus"></span>
                        <span id="montoLlave" class="llave"></span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Monto Externo/Referenciado</label>
                    <input type="text" class="input-field" id="montoExterno" placeholder="Ej: 80.000.000">
                    <div class="status-text">
                        <span id="externoLlave" class="llave"></span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Recuperados +3 meses</label>
                    <input type="text" class="input-field" id="montoRecuperado" placeholder="Ej: 60.000.000">
                    <div class="status-text">
                        <span id="recuperadoLlave" class="llave"></span>
                    </div>
                    <div class="help-text">Clientes recuperados después de 3 meses</div>
                </div>
                
                <div class="input-group">
                    <label>Cantidad Desembolsos <span class="req">*</span></label>
                    <input type="text" class="input-field required" id="cantidadDesembolsos" placeholder="Ej: 10">
                    <div class="status-text">
                        <span id="cantidadStatus"></span>
                    </div>
                </div>
                
                <div class="section-divider">═══ LLAVE SEMANAL ═══</div>
                
                <div class="input-group">
                    <label>Desembolsos semanales mínimos <span class="req">*</span> <span class="tooltip" data-tip="Cantidad de desembolsos en tu peor semana">ⓘ</span></label>
                    <input type="text" class="input-field required filled" id="menorSemana" value="2" placeholder="Ej: 2">
                    <div class="llave-info" id="llaveInfo">
                        <div><strong>LLAVE HABILITADA:</strong></div>
                        <div class="llave-rules">
                            <div>✅ 2/sem → habilita premio cantidad completo</div>
                            <div>❌ Menos de 2/sem → sin premio cantidad</div>
                        </div>
                    </div>
                </div>
                
                <div class="section-divider">═══ CALIDAD ═══</div>
                
                <div class="input-group">
                    <label>Conversión % <span class="req">*</span></label>
                    <input type="text" class="input-field required" id="conversion" placeholder="Ej: 7" maxlength="5" value="8">
                </div>
                
                <div class="input-group">
                    <label>Empatía/Mystery % <span class="req">*</span></label>
                    <input type="text" class="input-field required" id="empatia" placeholder="Ej: 92" maxlength="3" value="96">
                </div>
                
                <div class="input-group">
                    <label>Proceso/CRM % <span class="req">*</span></label>
                    <input type="text" class="input-field required" id="proceso" placeholder="Ej: 85" maxlength="3" value="95">
                </div>

                <div class="input-group">
                    <label>Mora % <span class="req">*</span></label>
                    <input type="text" class="input-field required" id="mora" placeholder="Ej: 2" maxlength="3" value="2">
                </div>
                
                <div class="section-divider">═══ OTROS ═══</div>
                
                <div class="input-group">
                    <label>Menor nivel del equipo</label>
                    <select class="input-field" id="nivelEquipo">
                        <option value="0">Capilla</option>
                        <option value="1">Junior</option>
                        <option value="2" selected>Senior A</option>
                        <option value="3">Senior B</option>
                        <option value="4">Máster</option>
                        <option value="5">Genio</option>
                    </select>
                    <div class="help-text">Para premio equipo (desde Senior A)</div>
                </div>
            </div>
        </div>

        <button id="openSidebarBtn" class="open-sidebar-btn">➡️ Mostrar</button>

        <div class="right-panel">
            <div class="top-stats">
                <div class="stat">
                    <span class="stat-label">Tu Nivel:</span>
                    <span class="stat-value" id="statNivel">Senior A</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Subtotal:</span>
                    <span class="stat-value" id="statSubtotal">0 Gs</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Multiplicador:</span>
                    <span class="stat-value" id="statMulti">0%</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Comisión:</span>
                    <span class="stat-value" style="color: #2E7D32;" id="statComision">0 Gs</span>
                </div>
            </div>
            
            <div class="results-container">
                <div class="card">
                    <div class="card-title">📊 MONTO INTERNO - Meta desembolso | Premio comisión</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="barraInterno"></div>
                    </div>
                    <div class="progress-info" id="infoInterno"></div>
                </div>
                
                <div class="card">
                    <div class="card-title">💎 MONTO EXTERNO/REFERENCIADO - Meta | Premio</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="barraExterno"></div>
                    </div>
                    <div class="progress-info" id="infoExterno"></div>
                </div>
                
                <div class="card">
                    <div class="card-title">🎯 CANTIDAD DESEMBOLSOS - Meta | Premio | Llave</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="barraCantidad"></div>
                    </div>
                    <div class="progress-info" id="infoCantidad"></div>
                </div>
                
                <div class="card">
                    <div class="card-title">🔄 RECUPERADOS +3 MESES - Meta | Premio</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="barraRecuperado"></div>
                    </div>
                    <div class="progress-info" id="infoRecuperado"></div>
                </div>
                
                <div class="card">
                    <div class="card-title">📈 PREMIO CARRERA - Según menor nivel últimos 2 meses</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="barraCarrera"></div>
                    </div>
                    <div class="progress-info" id="infoCarrera"></div>
                </div>
                
                <div class="card">
                    <div class="card-title">👥 PREMIO EQUIPO - Según menor nivel del equipo</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="barraEquipo"></div>
                    </div>
                    <div class="progress-info" id="infoEquipo"></div>
                    <div id="equipoRequisitos" style="margin-top: 8px; padding: 8px; background: #FFF3E0; border-radius: 4px; font-size: 11px; color: #E65100;">
                        ⚠️ Necesitas estar en Senior A+ para cobrar premio equipo
                    </div>
                </div>
                
                <div class="card full-width">
                    <div class="card-title">💰 SUBTOTAL ACUMULADO (sin multiplicadores)</div>
                    <div class="subtotal-bar">
                        <div class="subtotal-fill" id="subtotalFill"></div>
                    </div>
                    <div class="subtotal-text">
                        Subtotal: <strong id="subtotalMonto">0 Gs</strong> de <strong>14.000.000 Gs</strong>
                    </div>
                </div>
                
                <div class="card full-width">
                    <div class="card-title">⭐ MULTIPLICADORES (SE APLICAN EN CADENA)</div>
                    <div class="multiplier-tables" id="multiplicadorTables"></div>
                    <div class="multiplier-calc" id="multiplicadorCalc">
                        Cálculo: - × - × - = 0%
                    </div>
                </div>
                
                <div class="card full-width">
                    <div class="card-title">💰 CÁLCULO DE COMISIÓN Y SUGERENCIAS</div>
                    <div class="commission-calculation">
                        <div class="calc-section">
                            <div class="calc-row">
                                <span>Base fija:</span>
                                <span id="calcBase">0 Gs</span>
                            </div>
                            <div class="calc-row">
                                <span>Carrera:</span>
                                <span id="calcCarrera">0 Gs</span>
                            </div>
                            <div class="calc-row">
                                <span>Monto Interno:</span>
                                <span id="calcInterno">0 Gs</span>
                            </div>
                            <div class="calc-row">
                                <span>Monto Ext/Ref:</span>
                                <span id="calcExterno">0 Gs</span>
                            </div>
                            <div class="calc-row">
                                <span>Recuperados:</span>
                                <span id="calcRecuperado">0 Gs</span>
                            </div>
                            <div class="calc-row">
                                <span>Cantidad <span id="cantidadLlaveInfo"></span>:</span>
                                <span id="calcCantidad">0 Gs</span>
                            </div>
                            <div class="calc-row">
                                <span>Equipo:</span>
                                <span id="calcEquipo">0 Gs</span>
                            </div>
                            <div class="calc-divider"></div>
                            
                            <div class="calc-row">
                                <span>Subtotal:</span>
                                <span id="calcSubtotal">0 Gs</span>
                            </div>
                            <div class="calc-row">
                                <span>× Multi:</span>
                                <span id="calcMultiplicador">0%</span>
                            </div>
                            
                            <div class="calc-total">
                                <div class="calc-total-label">TOTAL COMISIÓN</div>
                                <div class="calc-total-value" id="totalComision">0 Gs</div>
                            </div>
                        </div>
                        
                        <div class="suggestions-section">
                            <div class="card-title" style="margin-top: 0;">💡 SUGERENCIAS PERSONALIZADAS</div>
                            <div id="sugerencias"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card full-width">
                    <div class="info-section">
                        <h4>📖 CÓMO SE DEFINE TU CARRERA</h4>
                        Tu nivel de carrera se determina por el <strong>MENOR</strong> nivel alcanzado entre:
                        <br>• Monto Interno + Monto Externo + Recuperados + Cantidad Desembolsos
                        <br>• Se considera el menor de los últimos 2 meses para estabilidad
                        <br>• NO se consideran: Premio Equipo ni penalizaciones
                    </div>
                    
                    <div class="info-section quick-guide">
                        <h4>📚 GUÍA RÁPIDA</h4>
                        • <strong>Llaves:</strong> Sin 6 desemb. no hay premio interno | 2/sem habilita premio cantidad
                        <br>• <strong>Multiplicadores:</strong> Se aplican en cadena (Conv × Emp × Proc)
                        <br>• <strong>Base fija:</strong> Siempre 3M, nunca se multiplica
                        <br>• <strong>Equipo:</strong> Premio según menor nivel del equipo (desde Senior A)
                        <br>• <strong>Meta vs Premio:</strong> Meta = monto a desembolsar | Premio = comisión que ganás
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contenido de config.js
        const CONFIG = {
            base: 3000000,
            niveles: ['Capilla', 'Junior', 'Senior A', 'Senior B', 'Máster', 'Genio'],
            metas: {
                montoInterno:   [450000000, 600000000, 750000000, 900000000, 1050000000, 1200000000],
                montoExterno:   [80000000, 150000000, 220000000, 280000000, 340000000, 400000000],
                montoRecuperado:[60000000, 80000000, 100000000, 120000000, 135000000, 150000000],
                cantidad:       [6, 7, 8, 10, 11, 13]
            },
            pagos: {
                carrera:        [0, 500000, 1000000, 1500000, 2000000, 3000000],
                montoInterno:   [500000, 750000, 1000000, 1250000, 1500000, 2000000],
                montoExterno:   [500000, 750000, 1000000, 1250000, 1500000, 2000000],
                montoRecuperado:[250000, 500000, 750000, 1000000, 1250000, 1500000],
                cantidad:       [250000, 500000, 750000, 1000000, 1250000, 1500000],
                equipo:         [0, 0, 250000, 500000, 750000, 1000000]
            },
            multiplicadores: {
                conversion: [
                    { min: 8, text: '8%+', mult: 1.0 }, { min: 7, text: '7-7.99%', mult: 0.9 },
                    { min: 6, text: '6-6.99%', mult: 0.8 }, { min: 0, text: '<6%', mult: 0.5 }
                ],
                empatia: [
                    { min: 96, text: '96%+', mult: 1.0 }, { min: 92, text: '92-95%', mult: 0.9 },
                    { min: 88, text: '88-91%', mult: 0.8 }, { min: 0, text: '<88%', mult: 0.5 }
                ],
                proceso: [
                    { min: 95, text: '95%+', mult: 1.0 }, { min: 90, text: '90-94%', mult: 0.9 },
                    { min: 85, text: '85-89%', mult: 0.8 }, { min: 0, text: '<85%', mult: 0.5 }
                ],
                mora: [
                    { min: 0, text: '<= 2%', mult: 1.0 }, { min: 2.01, text: '2.01-3%', mult: 0.9 },
                    { min: 3.01, text: '3.01-4%', mult: 0.8 }, { min: 4.01, text: '> 4%', mult: 0.5 }
                ]
            }
        };
    </script>
    <script>
        // Contenido de pdf-generator.js
        function generarPDFMejorado() {
            // --- FUNCIONES AUXILIARES ---
            function formatNumber(num) {
                if (isNaN(num)) return "0";
                return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }
            function escapeHTML(str) {
                return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }
            function getValue(id, prop = 'value') {
                const el = document.getElementById(id);
                const value = el ? el[prop] : '';
                return escapeHTML(value);
            }
            function getNumericValue(id, prop = 'textContent') {
                const el = document.getElementById(id);
                const value = el ? el[prop] : '0';
                return parseInt(value.replace(/[^0-9]/g, ''), 10) || 0;
            }

            // --- RECOLECCIÓN DE DATOS ---
            const fecha = new Date();
            const mesActual = fecha.toLocaleDateString('es-PY', { month: 'long', year: 'numeric' });
            const fechaHora = fecha.toLocaleDateString('es-PY') + ' ' + fecha.toLocaleTimeString('es-PY', { hour: '2-digit', minute: '2-digit' });
            const nivelActual = getValue('statNivel', 'textContent');
            const comisionTotal = getValue('totalComision', 'textContent');
            const multiplicadorFinal = getValue('statMulti', 'textContent');
            const subtotal = getValue('calcSubtotal', 'textContent');
            const montoInterno = getNumericValue('montoInterno', 'value');
            const montoExterno = getNumericValue('montoExterno', 'value');
            const montoRecuperado = getNumericValue('montoRecuperado', 'value');
            const totalDesembolsado = montoInterno + montoExterno + montoRecuperado;
            const cantidadDesembolsos = getValue('cantidadDesembolsos') || '0';
            const premioBase = getNumericValue('calcBase');
            const premioCarrera = getNumericValue('calcCarrera');
            const premioInterno = getNumericValue('calcInterno');
            const premioExterno = getNumericValue('calcExterno');
            const premioRecuperado = getNumericValue('calcRecuperado');
            const premioCantidad = getNumericValue('calcCantidad');
            const premioEquipo = getNumericValue('calcEquipo');
            const config = getConfig();

            // --- LÓGICA PARA EL REPORTE ---
            function getProgressHTML(label, value, max, unit) {
                const percentage = Math.min((value / max) * 100, 100);
                const isComplete = percentage >= 100;
                return `
                    <div class="progress-item">
                        <div class="progress-header">
                            <span><strong>${label}</strong></span>
                            <span>${formatNumber(value)} ${unit}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${isComplete ? 'complete' : ''}" style="width: ${percentage}%">
                                ${Math.round(percentage)}%
                            </div>
                        </div>
                    </div>`;
            }

            function getQualityIndicatorsHTML() {
                const indicadores = ['conversion', 'empatia', 'proceso', 'mora'];
                let rowsHTML = '';
                indicadores.forEach(tipo => {
                    const valor = parseFloat(getValue(tipo)) || 0;
                    const { mult, status, badgeClass } = Calculos.getMultiplicadorInfo(tipo, valor, config.multiplicadores);
                    rowsHTML += `
                        <tr>
                            <td>${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</td>
                            <td class="text-center">${valor}%</td>
                            <td class="text-center">${(mult * 100).toFixed(0)}%</td>
                            <td class="text-center"><span class="badge ${badgeClass}">${status}</span></td>
                        </tr>`;
                });
                return rowsHTML;
            }
            
            function getCommissionBreakdownHTML() {
                const subtotalNum = getNumericValue('calcSubtotal');
                if (subtotalNum === 0) return '<tr><td colspan="3">No hay comisiones para mostrar.</td></tr>';
                const items = [
                    { nombre: 'Base Fija', valor: premioBase },
                    { nombre: 'Premio Carrera', valor: premioCarrera },
                    { nombre: 'Premio Monto Interno', valor: premioInterno },
                    { nombre: 'Premio Monto Externo', valor: premioExterno },
                    { nombre: 'Premio Recuperados', valor: premioRecuperado },
                    { nombre: 'Premio Cantidad', valor: premioCantidad },
                    { nombre: 'Premio Equipo', valor: premioEquipo }
                ];
                let html = '';
                items.forEach(item => {
                    if (item.valor > 0) {
                        const porcentaje = ((item.valor / subtotalNum) * 100).toFixed(1);
                        html += `
                            <tr>
                                <td>${item.nombre}</td>
                                <td class="text-right">${formatNumber(item.valor)} Gs</td>
                                <td class="text-center">${porcentaje}%</td>
                            </tr>`;
                    }
                });
                html += `<tr style="background: #f8f9fa; font-weight: 600;"><td>SUBTOTAL</td><td class="text-right">${formatNumber(subtotalNum)} Gs</td><td class="text-center">100%</td></tr>`;
                return html;
            }

            // --- CREACIÓN DE LA VENTANA Y EL HTML DEL REPORTE ---
            const ventana = window.open('', '_blank');
            ventana.document.write(`
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <title>Reporte de Comisiones - ${mesActual}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #2d3748; line-height: 1.6; }
                        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
                        .header { background: linear-gradient(135deg, #006D77 0%, #83C5BE 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,109,119,0.2); }
                        .header h1 { font-size: 28px; margin-bottom: 5px; font-weight: 300; }
                        .header .subtitle { font-size: 18px; opacity: 0.9; }
                        .header .date { font-size: 14px; opacity: 0.8; margin-top: 10px; }
                        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
                        .summary-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; }
                        .summary-card.primary { background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 100%); color: white; }
                        .summary-card .label { font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; margin-bottom: 8px; }
                        .summary-card .value { font-size: 28px; font-weight: 600; line-height: 1.2; }
                        .summary-card .detail { font-size: 14px; margin-top: 5px; opacity: 0.7; }
                        .section { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
                        .section-title { font-size: 20px; font-weight: 600; color: #006D77; margin-bottom: 20px; }
                        .progress-item { margin-bottom: 20px; }
                        .progress-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
                        .progress-bar { height: 24px; background: #e9ecef; border-radius: 12px; overflow: hidden; }
                        .progress-fill { height: 100%; background: linear-gradient(90deg, #006D77 0%, #83C5BE 100%); border-radius: 12px; transition: width 0.3s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; font-size: 12px; font-weight: 600; }
                        .progress-fill.complete { background: linear-gradient(90deg, #2E7D32 0%, #4CAF50 100%); }
                        table { width: 100%; border-collapse: collapse; }
                        th { background: #f8f9fa; padding: 12px 15px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; color: #6c757d; border-bottom: 2px solid #e9ecef; }
                        td { padding: 15px; border-bottom: 1px solid #e9ecef; font-size: 14px; }
                        tr:last-child td { border-bottom: none; }
                        .text-right { text-align: right; }
                        .text-center { text-align: center; }
                        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
                        .badge.success { background: #E8F5E9; color: #2E7D32; }
                        .badge.warning { background: #FFF3E0; color: #F57C00; }
                        .badge.danger { background: #FFEBEE; color: #D32F2F; }
                        .chart-container { display: flex; justify-content: center; align-items: center; margin: 20px 0; }
                        .chart-legend { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
                        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 14px; }
                        .legend-color { width: 16px; height: 16px; border-radius: 4px; }
                        .total-section { background: linear-gradient(135deg, #006D77 0%, #83C5BE 100%); color: white; padding: 30px; border-radius: 12px; text-align: center; margin: 30px 0; }
                        .total-label { font-size: 16px; opacity: 0.9; margin-bottom: 10px; }
                        .total-amount { font-size: 42px; font-weight: 700; margin: 10px 0; }
                        .footer { text-align: center; color: #6c757d; font-size: 12px; margin-top: 40px; padding: 20px; }
                        @media print { body { background: white; print-color-adjust: exact; -webkit-print-color-adjust: exact; } .container { max-width: 100%; } }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>Reporte de Comisiones</h1>
                            <div class="subtitle">SERSA SAECA - Sistema Comercial</div>
                            <div class="date">Período: ${mesActual}</div>
                        </div>
                        <div class="summary-grid">
                            <div class="summary-card primary"><div class="label">Comisión Total</div><div class="value">${comisionTotal}</div><div class="detail">Guaraníes</div></div>
                            <div class="summary-card"><div class="label">Nivel Alcanzado</div><div class="value">${nivelActual}</div><div class="detail">Este mes</div></div>
                            <div class="summary-card"><div class="label">Total Desembolsado</div><div class="value">${formatNumber(totalDesembolsado)}</div><div class="detail">Gs</div></div>
                            <div class="summary-card"><div class="label">Multiplicador</div><div class="value">${multiplicadorFinal}</div><div class="detail">Calidad</div></div>
                        </div>
                        <div class="section"><h2 class="section-title">📊 Progreso de Metas</h2>
                            ${getProgressHTML('Monto Interno', montoInterno, 1200000000, 'Gs')}
                            ${getProgressHTML('Monto Externo', montoExterno, 400000000, 'Gs')}
                            ${getProgressHTML('Recuperados', montoRecuperado, 150000000, 'Gs')}
                            ${getProgressHTML('Cantidad Desembolsos', parseInt(cantidadDesembolsos), 13, 'operaciones')}
                        </div>
                        <div class="section"><h2 class="section-title">⭐ Indicadores de Calidad</h2><table><thead><tr><th>Indicador</th><th class="text-center">Valor</th><th class="text-center">Multiplicador</th><th class="text-center">Estado</th></tr></thead><tbody>${getQualityIndicatorsHTML()}</tbody></table></div>
                        <div class="section"><h2 class="section-title">💰 Distribución de Comisión</h2><div class="chart-container"><canvas id="pieChart" width="300" height="300"></canvas></div><div class="chart-legend" id="chartLegend"></div><table style="margin-top: 20px;"><thead><tr><th>Concepto</th><th class="text-right">Monto (Gs)</th><th class="text-center">%</th></tr></thead><tbody>${getCommissionBreakdownHTML()}</tbody></table></div>
                        <div class="total-section"><div class="total-label">COMISIÓN TOTAL DEL MES</div><div class="total-amount">${comisionTotal}</div><div style="font-size: 14px; opacity: 0.9;">Subtotal: ${subtotal} × Multiplicador: ${multiplicadorFinal}</div></div>
                        <div class="footer"><p>Reporte generado el ${fechaHora}</p><p>Sistema de Comisiones Comerciales - SERSA SAECA</p></div>
                    </div>
                    <script>
                        window.onload = function() {
                            const canvas = document.getElementById('pieChart');
                            if (!canvas) return;
                            const ctx = canvas.getContext('2d');
                            const centerX = canvas.width / 2;
                            const centerY = canvas.height / 2;
                            const radius = 120;
                            const data = [
                                ${premioBase > 0 ? `{label: 'Base Fija', value: ${premioBase}, color: '#006D77'},` : ''}
                                ${premioCarrera > 0 ? `{label: 'Carrera', value: ${premioCarrera}, color: '#83C5BE'},` : ''}
                                ${premioInterno > 0 ? `{label: 'Interno', value: ${premioInterno}, color: '#4CAF50'},` : ''}
                                ${premioExterno > 0 ? `{label: 'Externo', value: ${premioExterno}, color: '#FFA726'},` : ''}
                                ${premioRecuperado > 0 ? `{label: 'Recuperados', value: ${premioRecuperado}, color: '#AB47BC'},` : ''}
                                ${premioCantidad > 0 ? `{label: 'Cantidad', value: ${premioCantidad}, color: '#EF5350'},` : ''}
                                ${premioEquipo > 0 ? `{label: 'Equipo', value: ${premioEquipo}, color: '#42A5F5'},` : ''}
                            ].filter(Boolean);
                            if(data.length === 0) return;
                            const total = data.reduce((sum, item) => sum + item.value, 0);
                            let currentAngle = -Math.PI / 2;
                            data.forEach(item => {
                                const sliceAngle = (item.value / total) * 2 * Math.PI;
                                ctx.beginPath();
                                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                                ctx.lineTo(centerX, centerY);
                                ctx.fillStyle = item.color;
                                ctx.fill();
                                ctx.strokeStyle = 'white';
                                ctx.lineWidth = 2;
                                ctx.stroke();
                                currentAngle += sliceAngle;
                            });
                            const legendHTML = data.map(item => {
                                const percentage = ((item.value / total) * 100).toFixed(1);
                                return \`<div class="legend-item"><div class="legend-color" style="background: \${item.color}"></div><span>\${item.label} (\${percentage}%)</span></div>\`;
                            }).join('');
                            document.getElementById('chartLegend').innerHTML = legendHTML;
                        };
                    <\/script>
                </body>
                </html>
            `);
            ventana.document.close();
        }
    </script>
    <script>
        // Contenido de calculos.js
        const Calculos = (function() {
            function calcularMultiplicador(tipo, valor, multiplicadores) {
                const tabla = multiplicadores[tipo];
                if (!tabla) return 0;
                if (tipo === 'mora') {
                    for (let i = tabla.length - 1; i >= 0; i--) {
                        if (valor >= tabla[i].min) return tabla[i].mult;
                    }
                    return 0;
                }
                for (const item of tabla) {
                    if (valor >= item.min) return item.mult;
                }
                return 0;
            }

            function getNivelAlcanzado(tipo, valor, metas) {
                const metas_array = metas[tipo];
                let nivelAlcanzado = -1;
                for (let i = 0; i < metas_array.length; i++) {
                    if (valor >= metas_array[i]) {
                        nivelAlcanzado = i;
                    } else {
                        break;
                    }
                }
                return nivelAlcanzado;
            }
            
            function getMultiplicadorInfo(tipo, valor, multiplicadores) {
                const mult = calcularMultiplicador(tipo, valor, multiplicadores);
                let status = 'Mejorar', badgeClass = 'danger';
                if (mult >= 1) { status = 'Óptimo'; badgeClass = 'success'; }
                else if (mult >= 0.8) { status = 'Regular'; badgeClass = 'warning'; }
                return { mult, status, badgeClass };
            }

            function generarSugerencias(values, results, config) {
                const { niveles, pagos } = config;
                const { nivelInterno, nivelExterno, nivelRecuperado, nivelCantidadReal, subtotal, multiplicadores } = results;
                const sugerencias = [];
                const limitantes = [
                    { tipo: 'Monto Interno', nivel: nivelInterno },
                    { tipo: 'Monto Externo', nivel: nivelExterno },
                    { tipo: 'Recuperados', nivel: nivelRecuperado },
                    { tipo: 'Cantidad', nivel: nivelCantidadReal }
                ].filter(l => l.nivel >= 0);

                if (limitantes.length > 0) {
                    const limitante = limitantes.reduce((min, curr) => curr.nivel < min.nivel ? curr : min);
                    if (limitante.nivel < 5) {
                        const siguienteNivel = niveles[limitante.nivel + 1];
                        const diferenciaPremio = pagos.carrera[limitante.nivel + 1] - pagos.carrera[limitante.nivel];
                        if (diferenciaPremio > 0) {
                            sugerencias.push({
                                categoria: 'high-priority',
                                titulo: '🚨 Tu Limitante Principal',
                                texto: `Tu ${limitante.tipo} (${niveles[limitante.nivel]}) limita tu carrera. Alcanzando ${siguienteNivel} en este indicador sumarías ${UI.formatNumber(diferenciaPremio)} Gs en premio carrera.`
                            });
                        }
                    }
                }
                
                if (values.menorSemana < 2 && values.cantidad >= 6) {
                    const premioPotencial = nivelCantidadReal >= 0 ? pagos.cantidad[nivelCantidadReal] : 0;
                    sugerencias.push({ categoria: 'alerts', titulo: '⚠️ Alertas', texto: `Sin 2 desembolsos/semana no cobrás premio por cantidad (estás perdiendo ${UI.formatNumber(premioPotencial)} Gs).` });
                }
                if (values.cantidad < 6 && (nivelInterno >= 0 || nivelExterno >= 0 || nivelRecuperado >= 0)) {
                    sugerencias.push({ categoria: 'alerts', titulo: '⚠️ Alertas', texto: `Te faltan ${6 - values.cantidad} desembolsos para activar los premios por montos (interno, externo, recuperado).` });
                }

                const peorMultiplicador = Object.entries(multiplicadores).filter(([tipo]) => tipo !== 'mora' && tipo !== 'total').map(([tipo, valor]) => ({ tipo, valor })).reduce((min, curr) => curr.valor < min.valor ? curr : min, { tipo: '', valor: 1 });
                if (peorMultiplicador.valor < 1) {
                    const mejoraPotencial = (subtotal - config.base) * (1 - peorMultiplicador.valor);
                    sugerencias.push({ categoria: 'multipliers', titulo: '⚡ Mejora de Multiplicadores', texto: `Tu ${peorMultiplicador.tipo} es tu punto más débil. Llevarlo al 100% podría sumar hasta ${UI.formatNumber(mejoraPotencial)} Gs a tu comisión.` });
                }
                return sugerencias;
            }

            function computeAll(values, config) {
                const { base, metas, pagos, multiplicadores: multConfig } = config;
                const nivelInterno = getNivelAlcanzado('montoInterno', values.montoInterno, metas);
                const nivelExterno = getNivelAlcanzado('montoExterno', values.montoExterno, metas);
                const nivelRecuperado = getNivelAlcanzado('montoRecuperado', values.montoRecuperado, metas);
                const nivelCantidadReal = getNivelAlcanzado('cantidad', values.cantidad, metas);
                const nivelesAlcanzadosEsteMes = [nivelInterno, nivelExterno, nivelRecuperado, nivelCantidadReal].filter(n => n >= 0);
                const nivelMinimoEsteMes = nivelesAlcanzadosEsteMes.length > 0 ? Math.min(...nivelesAlcanzadosEsteMes) : -1;
                const nivelCarrera = Math.min(nivelMinimoEsteMes, values.nivelAnterior);
                const cumpleLlaveMonto = values.cantidad >= 6;
                const cumpleLlaveCantidad = values.menorSemana >= 2;
                const nivelCantidadLimitado = cumpleLlaveCantidad ? nivelCantidadReal : -1;
                const bonusCarrera = nivelCarrera >= 0 ? pagos.carrera[nivelCarrera] : 0;
                const bonusInterno = (nivelInterno >= 0 && cumpleLlaveMonto) ? pagos.montoInterno[nivelInterno] : 0;
                const bonusExterno = (nivelExterno >= 0 && cumpleLlaveMonto) ? pagos.montoExterno[nivelExterno] : 0;
                const bonusRecuperado = (nivelRecuperado >= 0 && cumpleLlaveMonto) ? pagos.montoRecuperado[nivelRecuperado] : 0;
                const bonusCantidad = nivelCantidadLimitado >= 0 ? pagos.cantidad[nivelCantidadLimitado] : 0;
                let bonusEquipo = 0;
                if (nivelCarrera >= 2 && values.nivelEquipo >= 2) { bonusEquipo = pagos.equipo[values.nivelEquipo]; }
                const subtotal = base + bonusCarrera + bonusInterno + bonusExterno + bonusRecuperado + bonusCantidad + bonusEquipo;
                const multiConversion = calcularMultiplicador('conversion', values.conversion, multConfig);
                const multiEmpatia = calcularMultiplicador('empatia', values.empatia, multConfig);
                const multiProceso = calcularMultiplicador('proceso', values.proceso, multConfig);
                const multiMora = calcularMultiplicador('mora', values.mora, multConfig);
                const multiplicadorTotal = Math.max(multiConversion * multiEmpatia * multiProceso * multiMora, 0.1);
                const parteVariable = subtotal - base;
                const total = base + (parteVariable * multiplicadorTotal);

                return {
                    nivelInterno, nivelExterno, nivelRecuperado, nivelCantidadReal, nivelCarrera, cumpleLlaveMonto, cumpleLlaveCantidad,
                    bonos: { carrera: bonusCarrera, interno: bonusInterno, externo: bonusExterno, recuperado: bonusRecuperado, cantidad: bonusCantidad, equipo: bonusEquipo },
                    subtotal,
                    multiplicadores: { conversion: multiConversion, empatia: multiEmpatia, proceso: multiProceso, mora: multiMora, total: multiplicadorTotal },
                    total
                };
            }
            return { computeAll, getMultiplicadorInfo, generarSugerencias };
        })();
    </script>
    <script>
        // Contenido de ui.js
        const UI = (function() {
            function formatNumber(num) {
                if (isNaN(num)) return "0";
                return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }
            function getElement(id) { return document.getElementById(id); }
            function getNumericValue(id) {
                const input = getElement(id);
                if (!input) return 0;
                return parseInt(input.value.replace(/\D/g, ''), 10) || 0;
            }

            function updateProgressBar(tipo, valor, nivelAlcanzado, config) {
                const { niveles, metas, pagos } = config;
                const tipoLower = tipo.toLowerCase();
                const container = getElement(`barra${tipo}`);
                const info = getElement(`info${tipo}`);
                if (!container || !info) return;

                let maxMeta;
                if (tipo === 'Interno') maxMeta = 1200000000;
                else if (tipo === 'Externo') maxMeta = 400000000;
                else if (tipo === 'Recuperado') maxMeta = 150000000;
                else if (tipo === 'Cantidad') maxMeta = 13;
                
                let html = '<div class="progress-segments">';
                for (let i = 0; i < niveles.length; i++) {
                    const className = `progress-segment ${i <= nivelAlcanzado ? 'reached' : ''} ${i === nivelAlcanzado ? 'current' : ''}`;
                    const metaTexto = tipo === 'Cantidad' ? metas.cantidad[i] : formatNumber(metas[tipoLower][i] / 1000000) + 'M';
                    const premioTexto = formatNumber(pagos[tipoLower][i]);
                    html += `<div class="${className}" data-tipo="${tipoLower}" data-valor="${metas[tipoLower][i]}"><div class="level">${niveles[i]}</div><div class="meta">Meta: ${metaTexto}</div><div class="premio">Premio: ${premioTexto}</div></div>`;
                }
                html += '</div>';
                container.innerHTML = html;
                const progreso = maxMeta > 0 ? Math.round((valor / maxMeta) * 100) : 0;
                const nivelTexto = nivelAlcanzado >= 0 ? niveles[nivelAlcanzado] : 'Ninguno';
                const premioTexto = nivelAlcanzado >= 0 ? formatNumber(pagos[tipoLower][nivelAlcanzado]) : '0';
                info.innerHTML = `Progreso: ${tipo === 'Cantidad' ? valor : formatNumber(valor)} / ${tipo === 'Cantidad' ? maxMeta : formatNumber(maxMeta)} (${progreso}%)<br>Nivel alcanzado: <strong>${nivelTexto}</strong> | Premio: <strong>${premioTexto} Gs</strong>`;
            }

            function updateCarreraBar(nivelCarrera, config) {
                const { niveles, pagos } = config;
                const container = getElement('barraCarrera');
                const info = getElement('infoCarrera');
                if (!container || !info) return;
                let html = '<div class="progress-segments">';
                for (let i = 0; i < niveles.length; i++) {
                    const className = `progress-segment ${i <= nivelCarrera ? 'reached' : ''} ${i === nivelCarrera ? 'current' : ''}`;
                    const premio = pagos.carrera[i];
                    html += `<div class="${className}" style="${premio === 0 ? 'opacity: 0.5;' : ''}"><div class="level">${niveles[i]}</div><div class="premio">Premio: ${formatNumber(premio)}</div></div>`;
                }
                html += '</div>';
                container.innerHTML = html;
                const nivelTexto = nivelCarrera >= 0 ? niveles[nivelCarrera] : 'Sin carrera';
                const premioCarrera = nivelCarrera >= 0 ? pagos.carrera[nivelCarrera] : 0;
                info.innerHTML = `Tu nivel de carrera: <strong>${nivelTexto}</strong> | Premio: <strong>${formatNumber(premioCarrera)} Gs</strong><br><span class="text-muted">Definido por el menor nivel de los últimos 2 meses</span>`;
            }

            function updateEquipoBar(nivelEquipo, nivelCarrera, bonus, config) {
                const { niveles, pagos } = config;
                const container = getElement('barraEquipo');
                const info = getElement('infoEquipo');
                const requisitos = getElement('equipoRequisitos');
                if (!container || !info || !requisitos) return;
                let html = '<div class="progress-segments">';
                for (let i = 0; i < niveles.length; i++) {
                    const className = `progress-segment ${i === nivelEquipo ? 'current' : ''}`;
                    const premio = pagos.equipo[i];
                    html += `<div class="${className}" style="${premio === 0 ? 'opacity: 0.5;' : ''}"><div class="level">${niveles[i]}</div><div class="premio">Premio: ${formatNumber(premio)}</div></div>`;
                }
                html += '</div>';
                container.innerHTML = html;
                info.innerHTML = `Menor nivel del equipo: <strong>${niveles[nivelEquipo] || 'N/A'}</strong> | Tu nivel: <strong>${niveles[nivelCarrera] || 'N/A'}</strong> | Premio: <strong>${formatNumber(bonus)} Gs</strong>`;
                if (nivelCarrera < 2) { requisitos.style.display = 'block'; requisitos.innerHTML = '⚠️ Necesitas ser Senior A+ para cobrar premio equipo'; }
                else if (nivelEquipo < 2) { requisitos.style.display = 'block'; requisitos.innerHTML = '⚠️ El equipo necesita ser Senior A+ para activar el premio'; }
                else { requisitos.style.display = 'block'; requisitos.innerHTML = '✅ Premio de equipo activado'; }
            }

            function updateMultiplicadorTables(values, results, config) {
                const { multiplicadores: multConfig } = config;
                const container = getElement('multiplicadorTables');
                if(!container) return;
                let html = '';
                const tipos = ['conversion', 'empatia', 'proceso', 'mora'];
                tipos.forEach(tipo => {
                    const valorActual = values[tipo];
                    const { badgeClass } = Calculos.getMultiplicadorInfo(tipo, valorActual, multConfig);
                    html += `<div class="multiplier-table ${badgeClass}"><div class="multiplier-title">${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</div>`;
                    multConfig[tipo].forEach(item => {
                        const tabla = multConfig[tipo];
                        let isActive = false;
                        if (tipo === 'mora') {
                            const index = tabla.findIndex(t => t.min === item.min);
                            const nextItem = tabla[index + 1];
                            isActive = valorActual >= item.min && (!nextItem || valorActual < nextItem.min);
                        } else {
                            const index = tabla.findIndex(t => t.min === item.min);
                            const nextItem = tabla[index - 1];
                            isActive = valorActual >= item.min && (!nextItem || valorActual < nextItem.min);
                        }
                        html += `<div class="multiplier-row ${isActive ? 'active' : ''}" data-tipo="${tipo}" data-valor="${item.min}"><span>${item.text}</span><span>→ ${Math.round(item.mult * 100)}%</span></div>`;
                    });
                    html += `<div class="multiplier-current">Tu valor: ${valorActual}%</div></div>`;
                });
                container.innerHTML = html;
                const { conversion, empatia, proceso, mora, total } = results.multiplicadores;
                getElement('multiplicadorCalc').textContent = `Cálculo: ${conversion.toFixed(2)} × ${empatia.toFixed(2)} × ${proceso.toFixed(2)} × ${mora.toFixed(2)} = ${(total*100).toFixed(1)}%`;
            }

            function renderSuggestions(sugerencias) {
                const container = getElement('sugerencias');
                if (!container) return;
                if (sugerencias.length === 0) { container.innerHTML = '<div class="suggestion-item">¡Excelente trabajo! Estás optimizando todos tus indicadores.</div>'; return; }
                container.innerHTML = sugerencias.map(s => `<div class="suggestion-category ${s.categoria}"><div class="suggestion-category-title">${s.titulo}</div><div class="suggestion-item">${s.texto}</div></div>`).join('');
            }

            function renderAll(values, results, config) {
                getElement('statNivel').textContent = results.nivelCarrera >= 0 ? config.niveles[results.nivelCarrera] : 'N/A';
                getElement('statSubtotal').textContent = formatNumber(results.subtotal) + ' Gs';
                getElement('statMulti').textContent = (results.multiplicadores.total * 100).toFixed(1) + '%';
                getElement('statComision').textContent = formatNumber(results.total) + ' Gs';
                updateProgressBar('Interno', values.montoInterno, results.nivelInterno, config);
                updateProgressBar('Externo', values.montoExterno, results.nivelExterno, config);
                updateProgressBar('Recuperado', values.montoRecuperado, results.nivelRecuperado, config);
                updateProgressBar('Cantidad', values.cantidad, results.nivelCantidadReal, config);
                updateCarreraBar(results.nivelCarrera, config);
                updateEquipoBar(values.nivelEquipo, results.nivelCarrera, results.bonos.equipo, config);
                const maxSubtotal = config.base + config.pagos.carrera[5] + config.pagos.montoInterno[5] + config.pagos.montoExterno[5] + config.pagos.montoRecuperado[5] + config.pagos.cantidad[5] + config.pagos.equipo[5];
                const subtotalPercent = maxSubtotal > 0 ? (results.subtotal / maxSubtotal) * 100 : 0;
                getElement('subtotalFill').style.width = `${Math.min(subtotalPercent, 100)}%`;
                getElement('subtotalMonto').textContent = formatNumber(results.subtotal) + ' Gs';
                getElement('subtotalMonto').nextElementSibling.textContent = formatNumber(maxSubtotal) + ' Gs';
                updateMultiplicadorTables(values, results, config);
                getElement('calcBase').textContent = formatNumber(config.base) + ' Gs';
                getElement('calcCarrera').textContent = formatNumber(results.bonos.carrera) + ' Gs';
                getElement('calcInterno').textContent = formatNumber(results.bonos.interno) + ' Gs';
                getElement('calcExterno').textContent = formatNumber(results.bonos.externo) + ' Gs';
                getElement('calcRecuperado').textContent = formatNumber(results.bonos.recuperado) + ' Gs';
                getElement('calcCantidad').textContent = formatNumber(results.bonos.cantidad) + ' Gs';
                getElement('calcEquipo').textContent = formatNumber(results.bonos.equipo) + ' Gs';
                getElement('calcSubtotal').textContent = formatNumber(results.subtotal) + ' Gs';
                getElement('calcMultiplicador').textContent = (results.multiplicadores.total * 100).toFixed(1) + '%';
                getElement('totalComision').textContent = formatNumber(results.total) + ' Gs';
            }
            
            function getFormValues() {
                return {
                    nivelAnterior: parseInt(getElement('nivelAnterior').value, 10),
                    montoInterno: getNumericValue('montoInterno'),
                    montoExterno: getNumericValue('montoExterno'),
                    montoRecuperado: getNumericValue('montoRecuperado'),
                    cantidad: getNumericValue('cantidadDesembolsos'),
                    menorSemana: getNumericValue('menorSemana'),
                    conversion: parseFloat(getElement('conversion').value) || 0,
                    empatia: parseFloat(getElement('empatia').value) || 0,
                    proceso: parseFloat(getElement('proceso').value) || 0,
                    mora: parseFloat(getElement('mora').value) || 0,
                    nivelEquipo: parseInt(getElement('nivelEquipo').value, 10)
                };
            }
            return { renderAll, getFormValues, formatNumber };
        })();
    </script>
    <script>
        // Contenido de app.js
        let appConfig = {};
        function updateCalculations() {
            const values = UI.getFormValues();
            if (values.montoInterno > 0 && values.montoRecuperado > values.montoInterno * 0.5) {
                if (!updateCalculations.recAlertShown) {
                    alert('⚠️ Recuperados superan el 50% del monto interno');
                    updateCalculations.recAlertShown = true;
                }
            } else {
                updateCalculations.recAlertShown = false;
            }
            const results = Calculos.computeAll(values, appConfig);
            UI.renderAll(values, results, appConfig);
            const suggestions = Calculos.generarSugerencias(values, results, appConfig);
            UI.renderSuggestions(suggestions);
        }
        (function() {
            let saveTimer;
            const indicator = document.getElementById('saveIndicator');
            function showIndicator() { if (indicator) { indicator.textContent = '⚡ Guardando...'; indicator.classList.add('saving'); } }
            function hideIndicator() { if (indicator) { indicator.classList.remove('saving'); indicator.textContent = ''; } }
            function restoreDraft() {
                try {
                    const draft = JSON.parse(localStorage.getItem('draftCommission') || '{}');
                    Object.entries(draft).forEach(([id, val]) => {
                        const el = document.getElementById(id);
                        if (!el) return;
                        el.value = val;
                        if (el.classList.contains('required')) {
                            el.classList.toggle('filled', !!val);
                            el.classList.toggle('empty', !val);
                        }
                    });
                } catch (e) { console.warn('No se pudo restaurar el borrador.', e); }
            }
            function autosave(e) {
                const el = e.target;
                if (!el.id || !el.closest('.left-panel')) return;
                const draft = JSON.parse(localStorage.getItem('draftCommission') || '{}');
                draft[el.id] = el.value;
                showIndicator();
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    localStorage.setItem('draftCommission', JSON.stringify(draft));
                    hideIndicator();
                }, 500);
            }
            document.addEventListener('input', autosave);
            window.restoreDraft = restoreDraft;
        })();
        document.addEventListener('DOMContentLoaded', () => {
            appConfig = getConfig(); 
            Eventos.init(); 
            if(window.restoreDraft) { window.restoreDraft(); }
            updateCalculations();
        });
        function getConfig() {
            const savedConfig = localStorage.getItem('comisionesConfig');
            return savedConfig ? JSON.parse(savedConfig) : (typeof CONFIG !== 'undefined' ? CONFIG : {});
        }
    </script>
    <script>
        // Contenido de eventos.js
        const Eventos = (function() {
            let debounceTimer;
            function debounceUpdate() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => { updateCalculations(); }, 300);
            }
            function handleFormInput(event) {
                const input = event.target;
                if (!input.matches('input, select')) return;
                if (['montoInterno', 'montoExterno', 'montoRecuperado'].includes(input.id)) {
                    const value = input.value.replace(/\D/g, '');
                    const cursorPos = input.selectionStart;
                    const oldLength = input.value.length;
                    input.value = value ? UI.formatNumber(parseInt(value, 10)) : '';
                    const newLength = input.value.length;
                    if (cursorPos !== null) {
                        input.setSelectionRange(cursorPos + (newLength - oldLength), cursorPos + (newLength - oldLength));
                    }
                }
                if (input.classList.contains('required')) {
                    input.classList.toggle('filled', !!input.value);
                    input.classList.toggle('empty', !input.value);
                }
                debounceUpdate();
            }
            function handleContainerClick(event) {
                const target = event.target.closest('[data-tipo][data-valor]');
                if (target && (target.classList.contains('progress-segment') || target.classList.contains('multiplier-row'))) {
                    const tipo = target.dataset.tipo;
                    const valor = target.dataset.valor;
                    let inputId = tipo;
                    if (tipo === 'interno') inputId = 'montoInterno';
                    if (tipo === 'externo') inputId = 'montoExterno';
                    if (tipo === 'recuperado') inputId = 'montoRecuperado';
                    if (tipo === 'cantidad') inputId = 'cantidadDesembolsos';
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = valor;
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            }
            function limpiarTodo() {
                if (confirm('¿Seguro que querés limpiar todos los datos?')) {
                    document.querySelectorAll('.left-panel input, .left-panel select').forEach(el => {
                        const defaultValue = { 'nivelAnterior': '2', 'nivelEquipo': '2', 'menorSemana': '2', 'conversion': '8', 'empatia': '96', 'proceso': '95', 'mora': '2' }[el.id] || '';
                        el.value = defaultValue;
                        el.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
                    });
                    localStorage.removeItem('draftCommission');
                }
            }
            function toggleSidebar() {
                const panel = document.querySelector('.left-panel');
                const btn = document.getElementById('toggleSidebarBtn');
                const openBtn = document.getElementById('openSidebarBtn');
                panel.classList.toggle('collapsed');
                if (panel.classList.contains('collapsed')) {
                    btn.textContent = '➡️ Mostrar';
                    if (openBtn) openBtn.style.display = 'block';
                } else {
                    btn.textContent = '➡️ Ocultar';
                    if (openBtn) openBtn.style.display = 'none';
                }
            }
            function init() {
                const leftPanel = document.querySelector('.left-panel');
                const rightPanel = document.querySelector('.right-panel');
                leftPanel.addEventListener('input', handleFormInput);
                rightPanel.addEventListener('click', handleContainerClick);
                document.getElementById('limpiarBtn').addEventListener('click', limpiarTodo);
                document.getElementById('reporteBtn').addEventListener('click', generarPDFMejorado);
                document.getElementById('toggleSidebarBtn').addEventListener('click', toggleSidebar);
                document.getElementById('openSidebarBtn').addEventListener('click', toggleSidebar);
            }
            return { init };
        })();
    </script>
</body>
</html>
